{% load static %}  
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Task Management</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="{% static 'imgs/fav.png' %}">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <!-- System Messages -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                {{ message }}
                <button type="button" class="close-btn" onclick="this.parentElement.style.display='none';">&times;</button>
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="dashboard-container">
        <!-- Header -->
        <header class="header">
            <!-- Header Left -->
            <div class="header-left">
                <img src="{% static 'imgs/image_admin/logo.webp' %}" alt="Logo" class="logo">
                <h1 class="project-name">
                    <a href="{% url 'tasks:manager_tasks' %}" style="text-decoration: none; color: inherit;">
                        Task Management
                    </a>
                </h1>
            </div>

            <!-- Search Section -->
            <div class="search-section">
                <input type="text" placeholder="Search tasks..." class="search-input">
                <i class="fas fa-search search-icon"></i>
            </div>

            <!-- Header Right -->
            <div class="header-right">
                <div class="profile">
                    <img src="{% static 'imgs/image_admin/picture_admin.webp' %}" alt="Profile" class="profile-pic">
                    <span class="profile-name">{{ request.session.user_name }}</span>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <div class="sidebar">
            <h2>ğŸ“Š Dashboard</h2>
            <ul>
                <li><a href="#" onclick="filterTasks('all')"><i class="fas fa-tasks"></i> All Tasks</a></li>
                <li><a href="#" onclick="filterTasks('completed')"><i class="fas fa-check-circle"></i> Completed</a></li>
                <li><a href="#" onclick="filterTasks('delayed')"><i class="fas fa-clock"></i> Delayed</a></li>
                <li><a href="#" onclick="filterTasks('in_progress')"><i class="fas fa-cogs"></i> In Progress</a></li>
                <li><a href="#" onclick="filterTasks('Pending')"><i class="fas fa-cogs"></i> Pending</a></li>
            </ul>
            <button class="add-task-btn" onclick="showTaskForm()"><i class="fas fa-plus"></i> Add Task</button>
            <a href="#" class="logout-btn" onclick="logout()" style="text-decoration: none;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <h1>ğŸ“Œ Task Management</h1>

            <!-- Task Form (Initially Hidden) -->
            <div id="taskForm" class="task-form" style="display: none;">
                <h3 id="formTitle">â• Add New Task</h3>
                <form method="POST" id="taskFormElement" action="{% url 'tasks:add_task' %}">
                    {% csrf_token %}
                    <input type="hidden" name="task_id" id="taskId">

                    <!-- Task Category Dropdown -->
                    <label>ğŸ“‚ Task Category:</label>
                    <select name="category" required>
                        {% for category in categories %}
                            <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>

                    <label>âœï¸ Task Name:</label>
                    <input type="text" name="title" id="taskTitle" placeholder="Enter task name" required>

                    <label>ğŸ“ Task Description:</label>
                    <textarea name="description" id="taskDescription" placeholder="Enter task description"></textarea>

                    <label>ğŸ”¥ Priority:</label>
                    <select name="priority" id="taskPriority">
                        <option value="low">ğŸŸ¢ Low</option>
                        <option value="medium">ğŸŸ  Medium</option>
                        <option value="high">ğŸ”´ High</option>
                        <option value="urgent">ğŸš¨ Urgent</option>
                    </select>

                    <!-- Add Deadline Field -->
                    <label>â° Deadline:</label>
                    <input type="datetime-local" name="deadline" id="taskDeadline" required>

                    <div class="form-buttons">
                        <button type="submit" id="submitButton"><i class="fas fa-check"></i> Add</button>
                        <button type="button" onclick="hideTaskForm()"><i class="fas fa-times"></i> Cancel</button>
                    </div>
                </form>
            </div>

            <!-- Tasks Banner -->
            <div class="tasks-banner">
                <h2>ğŸ“‹ Tasks Overview</h2>
                <div id="taskList" class="task-list">
                    {% if tasks %}
                        {% for task in tasks %}
                            <div class="task-card {{ task.status }} {{ task.priority }}" data-status="{{ task.status }}">
                                <h3>{{ task.title }}</h3>
                                <p>{{ task.description }}</p>
                                <p><strong>Assigned to:</strong> {{ task.assigned_to.first_name }} {{ task.assigned_to.last_name }}</p>
                                <p><strong>Priority:</strong> {{ task.get_priority_display }}</p>
                                <p><strong>Status:</strong> {{ task.get_status_display }}</p>
                                <p><strong>Created At:</strong> {{ task.created_at }}</p>
                                <p><strong>Deadline:</strong> <span id="deadline-{{ task.id }}">{{ task.deadline }}</span></p>
                                <p><strong>Time Remaining:</strong> <span id="countdown-{{ task.id }}"></span></p>

                                <!-- Update Task Button -->
                                <button class="update-task-btn" onclick="showTaskForm('{{ task.id }}', '{{ task.title }}', '{{ task.description }}', '{{ task.priority }}', '{{ task.status }}', '{{ task.deadline }}')">
                                    <i class="fas fa-edit"></i> Update
                                </button>

                                <!-- Delete Task Button -->
                                <form method="POST" action="{% url 'tasks:delete_task' task.id %}" style="display: inline;" id="deleteForm-{{ task.id }}">
                                    {% csrf_token %}
                                    <button type="button" class="delete-task-btn" onclick="confirmDeleteTask('{{ task.id }}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </form>
                            </div>
                        {% endfor %}
                    {% else %}
                        ğŸ“‹ No tasks available
                    {% endif %}
                </div>
            </div>

            <!-- Employees Section -->
            <div class="employees-section">
                <h2>ğŸ‘¥ Employees Overview</h2>
                <div class="employees-list">
                    {% for data in employee_data %}
                        <div class="employee-card">
                            <h3>{{ data.first_name }} {{ data.last_name }}</h3>
                            <p><strong>Total Tasks:</strong> {{ data.total_tasks }}</p>
                            <p><strong>Delayed Tasks:</strong> {{ data.delayed_tasks }}</p>
                            <p><strong>Completed Tasks:</strong> {{ data.completed_tasks }}</p>
                        </div>
                    {% empty %}
                        <p>No employees found.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <script>
            // Function to show the form for adding or updating a task
            function showTaskForm(taskId = null, title = "", description = "", priority = "low", status = "pending", deadline = "") {
                const form = document.getElementById("taskForm");
                const formTitle = document.getElementById("formTitle");
                const submitButton = document.getElementById("submitButton");
                const taskFormElement = document.getElementById("taskFormElement");

                if (taskId) {
                    // Update mode
                    formTitle.textContent = "âœï¸ Update Task";
                    submitButton.innerHTML = '<i class="fas fa-save"></i> Save';
                    taskFormElement.action = `{% url 'tasks:update_task' 0 %}`.replace("0", taskId);
                } else {
                    // Add mode
                    formTitle.textContent = "â• Add New Task";
                    submitButton.innerHTML = '<i class="fas fa-check"></i> Add';
                    taskFormElement.action = "{% url 'tasks:add_task' %}";
                }

                // Populate form fields
                document.getElementById("taskId").value = taskId || "";
                document.getElementById("taskTitle").value = title;
                document.getElementById("taskDescription").value = description;
                document.getElementById("taskPriority").value = priority;
                document.getElementById("taskDeadline").value = deadline ? parseDeadline(deadline).toISOString().slice(0, 16) : "";

                // Show the form
                form.style.display = "block";
            }

            // Function to hide the form
            function hideTaskForm() {
                document.getElementById("taskForm").style.display = "none";
            }

            // Function to parse deadline (used for both add and update)
            function parseDeadline(deadline) {
                const months = {
                    "January": 0, "February": 1, "March": 2, "April": 3, "May": 4, "June": 5,
                    "July": 6, "August": 7, "September": 8, "October": 9, "November": 10, "December": 11
                };

                const parts = deadline.split(/[\s,]+/);
                const month = months[parts[0]];
                const day = parseInt(parts[1], 10);
                const year = parseInt(parts[2], 10);
                const timeParts = parts[3].split(":");
                let hour = parseInt(timeParts[0], 10);
                const minute = parseInt(timeParts[1], 10);
                const period = parts[4];

                // Convert to 24-hour format
                if (period === "p.m." && hour !== 12) {
                    hour += 12;
                } else if (period === "a.m." && hour === 12) {
                    hour = 0;
                }

                return new Date(year, month, day, hour, minute);
            }
            
            function filterTasks(status) {
                document.querySelectorAll('.task-card').forEach(task => {
                    task.style.display = (status === "all" || task.dataset.status === status) ? "block" : "none";
                });
            }

            // Function to calculate time remaining
            function updateCountdown(taskId, deadline) {
                const countdownElement = document.getElementById(`countdown-${taskId}`);
                if (!countdownElement) return;

                const deadlineDate = parseDeadline(deadline);
                if (isNaN(deadlineDate.getTime())) {
                    countdownElement.textContent = "Invalid deadline!";
                    return;
                }

                const now = new Date().getTime();
                const timeRemaining = deadlineDate.getTime() - now;

                if (timeRemaining <= 0) {
                    countdownElement.textContent = "Deadline passed!";
                    return;
                }

                const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);

                countdownElement.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            }

            // Function to initialize countdowns
            function initializeCountdowns() {
                document.querySelectorAll('.task-card').forEach(task => {
                    const taskId = task.querySelector('span[id^="countdown-"]').id.split('-')[1];
                    const deadline = task.querySelector('span[id^="deadline-"]').textContent.trim(); // Ensure no extra spaces
                    updateCountdown(taskId, deadline);
                    setInterval(() => updateCountdown(taskId, deadline), 1000);
                });
            }

            // Function to hide messages after 5 seconds
            function hideMessages() {
                const messages = document.querySelectorAll('.alert');
                messages.forEach(message => {
                    setTimeout(() => {
                        message.style.opacity = '0';
                        setTimeout(() => {
                            message.style.display = 'none';
                        }, 1000); // Fade out duration
                    }, 5000); // 5 seconds delay
                });
            }
            

            // Function to confirm task deletion
            function confirmDeleteTask(taskId) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        document.getElementById(`deleteForm-${taskId}`).submit();
                    }
                });
            }

            // Logout Function
            function logout() {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You are about to logout!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, logout!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = "{% url 'tasks:log_out' %}";
                    }
                });
            }

            // Initialize on page load
            window.onload = function() {
                initializeCountdowns();
                hideMessages();
            };
        </script>
    </div>
</body>
</html>